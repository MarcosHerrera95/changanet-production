# Matriz Completa de Errores: Sistema de Notificaciones y Alertas de ChangAnet

##  Resumen Ejecutivo

Esta matriz documenta todos los errores detectados en el m贸dulo de Notificaciones y Alertas de ChangAnet, bas谩ndose en an谩lisis exhaustivos del backend, frontend, base de datos y WebSocket. Se categorizan por severidad y se proporcionan fixes espec铆ficos y completos para cada problema identificado.

###  Estad铆sticas Generales
- **Total de Errores**: 28
- **Cr铆ticos**: 6 (21%)
- **Altos**: 8 (29%)
- **Medios**: 9 (32%)
- **Bajos**: 5 (18%)

---

##  ERRORES CRTICOS (Prioridad M谩xima - Implementar Inmediatamente)

| ID | Severidad | Archivo | L铆nea | Descripci贸n | Causa | Impacto | FIX Propuesto |
|----|-----------|---------|-------|-------------|-------|---------|--------------|
| CRIT-001 | CRTICO | `changanet-backend/src/services/notificationService.js` | 27-35 | WebSocket server no inicializado correctamente | Falta inicializaci贸n del WebSocket server en el arranque de la aplicaci贸n | Sistema de notificaciones en tiempo real completamente inoperativo | ```javascript<br>// En server.js, agregar:<br>const NotificationWebSocketServer = require('./websocket/notificationSocket');<br><br>// Despu茅s de crear el servidor HTTP:<br>const wsServer = new NotificationWebSocketServer(server);<br>notificationService.setWebSocketServer(wsServer);<br>``` |
| CRIT-002 | CRTICO | `changanet-backend/prisma/schema.prisma` | - | Modelo `notification_preferences` faltante | Esquema de base de datos incompleto para preferencias de usuario | Sistema de preferencias no puede almacenar configuraciones | ```prisma<br>model notification_preferences {<br>  id         String   @id @default(uuid())<br>  usuario_id String   @unique<br>  usuario    usuarios @relation(fields: [usuario_id], references: [id])<br><br>  enabled   Boolean  @default(true)<br>  timezone  String   @default("America/Buenos_Aires")<br><br>  canales   String   // JSON: {push: true, email: true, sms: false}<br>  categorias String  // JSON con configuraci贸n por categor铆a<br><br>  quiet_hours_enabled Boolean @default(false)<br>  quiet_start_time    String?<br>  quiet_end_time      String?<br><br>  creado_en  DateTime @default(now())<br>  actualizado_en DateTime?<br><br>  @@index([usuario_id])<br>}<br>``` |
| CRIT-003 | CRTICO | `changanet-backend/src/services/rateLimiterService.js` | - | Rate limiting no integrado en endpoints cr铆ticos | Servicio existe pero no se usa en controladores principales | Posible abuso del sistema de notificaciones | ```javascript<br>// En notificationController.js, agregar a cada endpoint:<br>const rateLimiter = require('../services/rateLimiterService');<br><br>exports.createNotification = async (req, res) => {<br>  // Rate limit check<br>  const canProceed = await rateLimiter.checkLimit(<br>    `notification_create:${req.user.id}`,<br>    10, // 10 por minuto<br>    60<br>  );<br><br>  if (!canProceed) {<br>    return res.status(429).json({ error: 'Rate limit exceeded' });<br>  }<br><br>  // ... resto del c贸digo<br>};<br>``` |
| CRIT-004 | CRTICO | `changanet-backend/src/services/pushNotificationService.js` | - | Servicio de push notifications referenciado pero no existe | Archivo faltante en el sistema | Notificaciones push no funcionan | ```javascript<br>// Crear src/services/pushNotificationService.js<br>const { sendPushNotification } = require('../config/firebaseAdmin');<br><br>class PushNotificationService {<br>  async registerFCMToken(userId, token) {<br>    await prisma.usuarios.update({<br>      where: { id: userId },<br>      data: { fcm_token: token }<br>    });<br>  }<br><br>  async unregisterFCMToken(userId) {<br>    await prisma.usuarios.update({<br>      where: { id: userId },<br>      data: { fcm_token: null }<br>    });<br>  }<br><br>  async sendPushNotification(userId, title, message, data = {}) {<br>    const user = await prisma.usuarios.findUnique({<br>      where: { id: userId },<br>      select: { fcm_token: true }<br>    });<br><br>    if (user?.fcm_token) {<br>      await sendPushNotification(user.fcm_token, title, message);<br>    }<br>  }<br>}<br><br>module.exports = new PushNotificationService();<br>``` |
| CRIT-005 | CRTICO | `changanet-backend/src/websocket/notificationSocket.js` | 192-233 | Autenticaci贸n WebSocket vulnerable | No valida tokens JWT correctamente, permite conexiones no autenticadas | Brecha de seguridad que permite eavesdropping | ```javascript<br>async handleConnection(ws, req) {<br>  try {<br>    const token = req.url.split('token=')[1]?.split('&')[0];<br>    if (!token) {<br>      ws.close(4001, 'Authentication required');<br>      return;<br>    }<br><br>    // Validar token con manejo de errores<br>    let decoded;<br>    try {<br>      decoded = jwt.verify(token, process.env.JWT_SECRET);<br>    } catch (jwtError) {<br>      console.error('JWT verification failed:', jwtError.message);<br>      ws.close(4002, 'Invalid token');<br>      return;<br>    }<br><br>    // Verificar expiraci贸n adicional<br>    if (decoded.exp && decoded.exp < Math.floor(Date.now() / 1000)) {<br>      ws.close(4003, 'Token expired');<br>      return;<br>    }<br><br>    const userId = decoded.userId;<br>    // ... resto del c贸digo<br>  } catch (error) {<br>    console.error('WebSocket connection error:', error);<br>    ws.close(4000, 'Connection failed');<br>  }<br>}<br>``` |
| CRIT-006 | CRTICO | `changanet-backend/src/services/notificationService.js` | 935-948 | Consultas N+1 en recordatorios de citas | Bucle que ejecuta consultas individuales para cada cita | Performance cr铆tica con muchos usuarios | ```javascript<br>// Reemplazar el bucle con consulta 煤nica<br>async function sendAppointmentReminders24h(now) {<br>  const tomorrow = new Date(now);<br>  tomorrow.setDate(tomorrow.getDate() + 1);<br><br>  const appointments = await prisma.appointments.findMany({<br>    where: {<br>      scheduled_start: {<br>        gte: new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate()),<br>        lt: new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate() + 1)<br>      },<br>      status: { in: ['scheduled', 'confirmed'] },<br>      reminder_sent: false<br>    },<br>    include: {<br>      client: { select: { id: true, nombre: true } },<br>      professional: { select: { id: true, nombre: true, especialidad: true } }<br>    }<br>  });<br><br>  // Procesar todas las citas en lote<br>  const notificationPromises = appointments.map(async (appointment) => {<br>    // ... l贸gica de notificaci贸n<br>  });<br><br>  await Promise.all(notificationPromises);<br><br>  // Marcar todas como enviadas en lote<br>  await prisma.appointments.updateMany({<br>    where: { id: { in: appointments.map(a => a.id) } },<br>    data: { reminder_sent: true }<br>  });<br>}<br>``` |

##  ERRORES DE ALTA SEVERIDAD (Implementar en Pr贸ximo Sprint)

| ID | Severidad | Archivo | L铆nea | Descripci贸n | Causa | Impacto | FIX Propuesto |
|----|-----------|---------|-------|-------------|-------|---------|--------------|
| HIGH-001 | ALTO | `changanet-backend/src/services/notificationService.js` | 204-216 | Campos de BD inconsistentes con el esquema | C贸digo usa campos que no existen en el modelo Prisma | Errores de BD en creaci贸n de notificaciones | ```javascript<br>// Actualizar creaci贸n de notificaciones<br>const notification = await prisma.notificaciones.create({<br>  data: {<br>    usuario_id: userId,<br>    tipo: type,<br>    prioridad: priority,<br>    titulo: processedContent.title || getNotificationTitle(type),<br>    mensaje: processedContent.body || message,<br>    metadata: JSON.stringify(metadata),<br>    canales_enviados: JSON.stringify(shouldSend.channels),<br>    fecha_envio: new Date(),<br>    // Agregar campos faltantes si existen en el esquema<br>    entity_type: metadata.entity_type,<br>    entity_id: metadata.entity_id<br>  }<br>});<br>``` |
| HIGH-002 | ALTO | `lib/notificationApi.ts` | 27-29 | API client mal configurado | `response.data.data` incorrecto, deber铆a ser `response.data` | Todas las llamadas API fallan | ```typescript<br>// Corregir todas las llamadas API<br>getUserNotifications: async (filters): Promise<NotificationResponse> => {<br>  const response = await apiClient.get<NotificationResponse>('/notifications', params);<br>  return response.data; // Quitar .data extra<br>},<br><br>getUnreadCount: async (): Promise<{ count: number }> => {<br>  const response = await apiClient.get<{ count: number }>('/notifications/unread-count');<br>  return response.data; // Quitar .data extra<br>},<br>// Aplicar a todos los m茅todos<br>``` |
| HIGH-003 | ALTO | `changanet-backend/src/controllers/notificationController.js` | 244-261 | Endpoint `getNotificationStats` no implementado | M茅todo llamado en controller pero no existe en service | Error 500 en estad铆sticas | ```javascript<br>// Agregar m茅todo en notificationService.js<br>exports.getUserNotificationStats = async (userId) => {<br>  const [total, unread, byType, byPriority] = await Promise.all([<br>    prisma.notificaciones.count({ where: { usuario_id: userId } }),<br>    prisma.notificaciones.count({<br>      where: { usuario_id: userId, esta_leido: false }<br>    }),<br>    prisma.notificaciones.groupBy({<br>      by: ['tipo'],<br>      where: { usuario_id: userId },<br>      _count: true<br>    }),<br>    prisma.notificaciones.groupBy({<br>      by: ['prioridad'],<br>      where: { usuario_id: userId },<br>      _count: true<br>    })<br>  ]);<br><br>  return {<br>    total,<br>    unread,<br>    byType: Object.fromEntries(byType.map(item => [item.tipo, item._count])),<br>    byPriority: Object.fromEntries(byPriority.map(item => [item.prioridad, item._count]))<br>  };<br>};<br>``` |
| HIGH-004 | ALTO | `changanet-backend/src/services/notificationService.js` | 563-605 | M茅todo `getGroupedNotifications` no implementado | Controller lo llama pero no existe | Error 500 en vista agrupada | ```javascript<br>// Implementar agrupaci贸n inteligente<br>exports.getGroupedNotifications = async (userId, options = {}) => {<br>  const notifications = await exports.getUserNotifications(userId, {<br>    ...options,<br>    limit: 100 // Obtener m谩s para agrupar<br>  });<br><br>  return groupSimilarNotifications(notifications.notifications);<br>};<br><br>function groupSimilarNotifications(notifications) {<br>  const groups = {};<br>  const singles = [];<br><br>  for (const notification of notifications) {<br>    const groupKey = generateGroupKey(notification);<br><br>    if (groupKey) {<br>      if (!groups[groupKey]) {<br>        groups[groupKey] = {<br>          id: groupKey,<br>          type: 'group',<br>          title: generateGroupTitle(notification),<br>          count: 0,<br>          notifications: [],<br>          lastUpdated: notification.creado_en<br>        };<br>      }<br>      groups[groupKey].notifications.push(notification);<br>      groups[groupKey].count++;<br>    } else {<br>      singles.push(notification);<br>    }<br>  }<br><br>  return [...Object.values(groups), ...singles];<br>}<br>``` |
| HIGH-005 | ALTO | `changanet-backend/src/routes/notificationRoutes.js` | - | Rutas de API incompletas | Faltan rutas para estad铆sticas, agrupaci贸n y preferencias | Funcionalidades no accesibles v铆a API | ```javascript<br>// Agregar rutas faltantes<br>const notificationController = require('../controllers/notificationController');<br><br>// Estad铆sticas<br>router.get('/stats', authenticate, notificationController.getNotificationStats);<br><br>// Agrupaci贸n<br>router.get('/grouped', authenticate, notificationController.getGroupedNotifications);<br><br>// Preferencias<br>router.get('/preferences', authenticate, notificationController.getNotificationPreferences);<br>router.put('/preferences', authenticate, notificationController.updateNotificationPreferences);<br><br>// FCM tokens<br>router.post('/fcm-token', authenticate, notificationController.registerFCMToken);<br>router.delete('/fcm-token', authenticate, notificationController.unregisterFCMToken);<br><br>// Test notification<br>router.post('/test', authenticate, notificationController.sendTestNotification);<br>``` |
| HIGH-006 | ALTO | `context/NotificationContext.tsx` | 668-698 | WebSocket connection no maneja reconexi贸n | P茅rdida de conexi贸n permanente al desconectarse | Notificaciones en tiempo real se pierden | ```typescript<br>// Agregar l贸gica de reconexi贸n autom谩tica<br>const [reconnectAttempts, setReconnectAttempts] = useState(0);<br>const maxReconnectAttempts = 5;<br><br>useEffect(() => {<br>  const connect = () => {<br>    const token = localStorage.getItem('authToken');<br>    if (!token) return;<br><br>    const wsUrl = `${process.env.REACT_APP_WS_URL}/ws/notifications?token=${token}`;<br>    const ws = new WebSocket(wsUrl);<br><br>    ws.onopen = () => {<br>      console.log('WebSocket connected');<br>      setIsConnected(true);<br>      setReconnectAttempts(0);<br>    };<br><br>    ws.onclose = () => {<br>      console.log('WebSocket disconnected');<br>      setIsConnected(false);<br><br>      // Intentar reconexi贸n con backoff exponencial<br>      if (reconnectAttempts < maxReconnectAttempts) {<br>        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);<br>        setTimeout(() => {<br>          setReconnectAttempts(prev => prev + 1);<br>          connect();<br>        }, delay);<br>      }<br>    };<br><br>    // ... resto de handlers<br>    setWsConnection(ws);<br>  };<br><br>  connect();<br>}, [reconnectAttempts]);<br>``` |
| HIGH-007 | ALTO | `changanet-backend/src/services/cacheService.js` | - | Cache service no maneja fallos de Redis | Errores de conexi贸n no manejados, aplicaci贸n se rompe | Sistema completo falla si Redis no est谩 disponible | ```javascript<br>// Mejorar manejo de errores en cacheService.js<br>class CacheService {<br>  constructor() {<br>    this.redis = new Redis(process.env.REDIS_URL || 'redis://localhost:6379');<br>    this.redis.on('error', (err) => {<br>      console.warn('Redis connection error:', err.message);<br>      // No tirar error, solo loggear<br>    });<br>    this.isConnected = false;<br><br>    this.redis.on('connect', () => {<br>      this.isConnected = true;<br>    });<br><br>    this.redis.on('disconnect', () => {<br>      this.isConnected = false;<br>    });<br>  }<br><br>  async get(key) {<br>    if (!this.isConnected) {<br>      console.warn('Redis not connected, skipping cache get');<br>      return null;<br>    }<br><br>    try {<br>      const value = await this.redis.get(key);<br>      return value ? JSON.parse(value) : null;<br>    } catch (error) {<br>      console.warn('Cache get error:', error.message);<br>      return null; // No fallar, devolver null<br>    }<br>  }<br><br>  async set(key, value, ttl = this.defaultTTL) {<br>    if (!this.isConnected) {<br>      console.warn('Redis not connected, skipping cache set');<br>      return;<br>    }<br><br>    try {<br>      await this.redis.setex(key, ttl, JSON.stringify(value));<br>    } catch (error) {<br>      console.warn('Cache set error:', error.message);<br>      // No fallar<br>    }<br>    }<br>  }<br>}<br>``` |
| HIGH-008 | ALTO | `changanet-backend/src/services/notificationTemplatesService.js` | - | Servicio de plantillas no maneja errores | Falla completa si plantilla no existe | Sistema de notificaciones se rompe | ```javascript<br>// Agregar manejo de errores robusto<br>exports.processTemplate = async (template, variables) => {<br>  try {<br>    if (!template) {<br>      console.warn('Template not found, using fallback');<br>      return {<br>        title: variables.title || 'Nueva notificaci贸n',<br>        body: variables.message || 'Tienes una nueva notificaci贸n'<br>      };<br>    }<br><br>    // Procesar template con variables<br>    let title = template.titulo_push || template.titulo_email || 'Nueva notificaci贸n';<br>    let body = template.mensaje_push || template.mensaje_email || 'Tienes una nueva notificaci贸n';<br><br>    // Reemplazar variables<br>    Object.keys(variables).forEach(key => {<br>      const regex = new RegExp(`\\$\\{${key}\\}`, 'g');<br>      title = title.replace(regex, variables[key] || '');<br>      body = body.replace(regex, variables[key] || '');<br>    });<br><br>    return { title, body };<br>  } catch (error) {<br>    console.error('Error processing template:', error);<br>    return {<br>      title: 'Nueva notificaci贸n',<br>      body: 'Tienes una nueva notificaci贸n'<br>    };<br>  }<br>};<br>``` |

##  ERRORES DE MEDIA SEVERIDAD (Mejoras de Experiencia)

| ID | Severidad | Archivo | L铆nea | Descripci贸n | Causa | Impacto | FIX Propuesto |
|----|-----------|---------|-------|-------------|-------|---------|--------------|
| MED-001 | MEDIO | `components/NotificationBell.tsx` | - | Componente no muestra indicadores de prioridad | Todas las notificaciones parecen igual de importantes | Usuario no puede priorizar visualmente | ```tsx<br>// Agregar indicadores de prioridad<br>const NotificationBell = ({ unreadCount, notifications }) => {<br>  const getPriorityColor = (priority) => {<br>    switch (priority) {<br>      case 'critical': return 'bg-red-500 animate-pulse';<br>      case 'high': return 'bg-orange-500';<br>      default: return 'bg-blue-500';<br>    }<br>  };<br><br>  const criticalCount = notifications.filter(n => n.prioridad === 'critical').length;<br><br>  return (<br>    <div className="relative"><br>      <Bell className="w-6 h-6" /><br>      {unreadCount > 0 && (<br>        <span className={`absolute -top-1 -right-1 text-xs text-white rounded-full px-1.5 py-0.5 ${<br>          criticalCount > 0 ? getPriorityColor('critical') : getPriorityColor('high')<br>        }`}><br>          {unreadCount}<br>        </span><br>      )}<br>    </div><br>  );<br>};<br>``` |
| MED-002 | MEDIO | `components/NotificationDropdown.tsx` | - | No agrupa notificaciones similares | Interface saturada con notificaciones repetitivas | Dificultad para navegar notificaciones | ```tsx<br>// Implementar agrupaci贸n en el componente<br>const NotificationDropdown = ({ notifications }) => {<br>  const groupedNotifications = useMemo(() => {<br>    const groups = {};<br>    notifications.forEach(notification => {<br>      const key = `${notification.tipo}_${notification.prioridad}`;<br>      if (groups[key]) {<br>        groups[key].count++;<br>      } else {<br>        groups[key] = { ...notification, count: 1 };<br>      }<br>    });<br>    return Object.values(groups);<br>  }, [notifications]);<br><br>  return (<br>    <div className="space-y-2"><br>      {groupedNotifications.map(group => (<br>        <div key={group.id} className="bg-gray-50 p-3 rounded-lg"><br>          <h4 className="font-medium">{group.title}</h4><br>          <p className="text-sm text-gray-600">{group.mensaje}</p><br>          <span className="text-xs text-gray-500">{group.count} notificaciones</span><br>        </div><br>      ))}<br>    </div><br>  );<br>};<br>``` |
| MED-003 | MEDIO | `changanet-backend/src/services/notificationService.js` | 163-243 | Validaci贸n insuficiente en creaci贸n de notificaciones | No valida tipos de datos, longitudes, formatos | Datos corruptos en BD | ```javascript<br>// Agregar validaci贸n completa<br>exports.createNotification = async (userId, type, message, metadata = {}, priority = 'MEDIUM') => {<br>  // Validaciones<br>  if (!userId || typeof userId !== 'string') {<br>    throw new Error('userId es requerido y debe ser string');<br>  }<br><br>  if (!message || typeof message !== 'string' || message.length > 1000) {<br>    throw new Error('message es requerido, debe ser string y menor a 1000 caracteres');<br>  }<br><br>  // Validar prioridad<br>  const validPriorities = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];<br>  if (!validPriorities.includes(priority)) {<br>    priority = 'MEDIUM';<br>  }<br><br>  // Sanitizar metadata<br>  const sanitizedMetadata = {};<br>  Object.keys(metadata).forEach(key => {<br>    if (typeof metadata[key] === 'string') {<br>      sanitizedMetadata[key] = metadata[key].substring(0, 500);<br>    } else if (typeof metadata[key] === 'number' || typeof metadata[key] === 'boolean') {<br>      sanitizedMetadata[key] = metadata[key];<br>    }<br>  });<br><br>  // ... usar sanitizedMetadata<br>};<br>``` |
| MED-004 | MEDIO | `hooks/useNotifications.ts` | - | Hook no maneja estados de loading y error | UX pobre durante cargas y errores | Usuario no sabe si operaci贸n est谩 en progreso | ```typescript<br>// Mejorar hook con estados completos<br>export const useNotifications = () => {<br>  const [loading, setLoading] = useState(false);<br>  const [error, setError] = useState(null);<br><br>  const markAsRead = useCallback(async (notificationId: string) => {<br>    setLoading(true);<br>    setError(null);<br>    try {<br>      await notificationApi.markAsRead(notificationId);<br>    } catch (err) {<br>      setError(err.message);<br>    } finally {<br>      setLoading(false);<br>    }<br>  }, []);<br><br>  return { loading, error, clearError: () => setError(null) };<br>};<br>``` |
| MED-005 | MEDIO | `changanet-backend/src/services/monitoringService.js` | - | M茅tricas no se registran autom谩ticamente | No hay tracking de uso del sistema | Sin datos para optimizaci贸n | ```javascript<br>// Integrar m茅tricas en notificationService.js<br>const monitoringService = require('./monitoringService');<br><br>exports.createNotification = async (userId, type, message, metadata = {}, priority = 'MEDIUM') => {<br>  const startTime = monitoringService.startNotificationTimer();<br><br>  try {<br>    // ... l贸gica<br>    monitoringService.recordNotificationSent(type, channel, priority);<br>    startTime();<br>    return notification;<br>  } catch (error) {<br>    monitoringService.recordNotificationFailed(type, error.message);<br>    startTime();<br>    throw error;<br>  }<br>};<br>``` |
| MED-006 | MEDIO | `changanet-backend/src/controllers/notificationController.js` | 16-34 | Paginaci贸n no implementada en getNotifications | Todas las notificaciones se cargan a la vez | Performance pobre con muchos usuarios | ```javascript<br>// Agregar paginaci贸n completa<br>exports.getNotifications = async (req, res) => {<br>  const { page = 1, limit = 20, priority, type } = req.query;<br><br>  // Validar par谩metros<br>  const pageNum = Math.max(1, parseInt(page));<br>  const limitNum = Math.min(100, Math.max(1, parseInt(limit)));<br><br>  const result = await notificationService.getUserNotifications(userId, {<br>    page: pageNum,<br>    limit: limitNum,<br>    priority,<br>    type<br>  });<br><br>  res.json({<br>    success: true,<br>    notifications: result.notifications,<br>    pagination: result.pagination,<br>    unreadCount: result.unreadCount<br>  });<br>};<br>``` |
| MED-007 | MEDIO | `types/notifications.ts` | - | Tipos TypeScript incompletos | Faltan tipos para preferencias, m茅tricas, filtros | Errores de tipo en desarrollo | ```typescript<br>// Completar definiciones<br>export interface NotificationPreferences {<br>  enabled: boolean;<br>  timezone: string;<br>  canales: Record<NotificationChannel, boolean>;<br>  categorias: Record<NotificationType, boolean>;<br>  quiet_hours_enabled: boolean;<br>  quiet_start_time?: string;<br>  quiet_end_time?: string;<br>}<br><br>export interface NotificationFilters {<br>  filter?: 'all' | 'unread' | 'read';<br>  priority?: NotificationPriority;<br>  page?: number;<br>  limit?: number;<br>}<br>``` |
| MED-008 | MEDIO | `changanet-backend/src/services/notificationService.js` | 748-791 | Sistema de notificaciones programadas incompleto | Usa campos que no existen en BD | Recordatorios no funcionan | ```javascript<br>// Implementar scheduling real<br>const schedule = require('node-schedule');<br><br>exports.scheduleNotification = async (userId, type, message, scheduledTime, metadata = {}, priority = 'medium') => {<br>  const scheduledNotification = await prisma.notificaciones.create({<br>    data: {<br>      usuario_id: userId,<br>      tipo: `scheduled_${type}`,<br>      titulo: getNotificationTitle(type),<br>      mensaje: message,<br>      metadata: JSON.stringify({ ...metadata, scheduled_for: scheduledTime }),<br>      programado_para: new Date(scheduledTime)<br>    }<br>  });<br><br>  // Programar job<br>  const job = schedule.scheduleJob(new Date(scheduledTime), async () => {<br>    await exports.createNotification(userId, type, message, metadata, priority);<br>  });<br><br>  return scheduledNotification;<br>};<br>``` |
| MED-009 | MEDIO | `changanet-backend/src/server.js` | - | Configuraci贸n de CORS insuficiente para WebSocket | WebSocket connections bloqueadas por CORS | Notificaciones en tiempo real no funcionan en producci贸n | ```javascript<br>// Configurar CORS para WebSocket<br>const cors = require('cors');<br><br>app.use(cors({<br>  origin: process.env.FRONTEND_URL || 'http://localhost:3000',<br>  credentials: true,<br>  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']<br>}));<br><br>// Para WebSocket<br>app.use('/ws', (req, res, next) => {<br>  res.header('Access-Control-Allow-Origin', process.env.FRONTEND_URL);<br>  res.header('Access-Control-Allow-Credentials', 'true');<br>  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');<br>  if (req.method === 'OPTIONS') {<br>    res.sendStatus(200);<br>  } else {<br>    next();<br>  }<br>});<br>``` |

##  ERRORES DE BAJA SEVERIDAD (Oportunidades de Mejora)

| ID | Severidad | Archivo | L铆nea | Descripci贸n | Causa | Impacto | FIX Propuesto |
|----|-----------|---------|-------|-------------|-------|---------|--------------|
| LOW-001 | BAJO | `changanet-backend/src/services/notificationService.js` | 649-684 | Funci贸n `getNotificationTitle` con c贸digo duplicado | L贸gica repetida para diferentes tipos | Mantenimiento dif铆cil | ```javascript<br>// Crear mapa centralizado<br>const NOTIFICATION_TITLES = {<br>  [NOTIFICATION_TYPES.BIENVENIDA]: '隆Bienvenido a ChangAnet!',<br>  [NOTIFICATION_TYPES.COTIZACION]: 'Nueva solicitud de presupuesto',<br>  // ... todos los tipos<br>};<br><br>function getNotificationTitle(type) {<br>  return NOTIFICATION_TITLES[type] || 'Nueva notificaci贸n';<br>}<br>``` |
| LOW-002 | BAJO | `changanet-backend/.env` | - | Variables de entorno hardcodeadas en c贸digo | Configuraci贸n no flexible | Dificultad para diferentes entornos | ```javascript<br>// Crear archivo .env completo<br>JWT_SECRET=your-secret-key<br>DATABASE_URL=postgresql://user:pass@localhost:5432/changanet<br>REDIS_URL=redis://localhost:6379<br>FIREBASE_PROJECT_ID=changanet<br>TWILIO_ACCOUNT_SID=your-sid<br>SENDGRID_API_KEY=your-key<br>FRONTEND_URL=http://localhost:3000<br>WS_URL=ws://localhost:3002<br>``` |
| LOW-003 | BAJO | `changanet-backend/src/services/notificationService.js` | 113-142 | Constantes NOTIFICATION_TYPES duplicadas | Definidas en m煤ltiples lugares | Inconsistencias potenciales | ```javascript<br>// Crear archivo constants/notificationConstants.js<br>const NOTIFICATION_TYPES = {<br>  BIENVENIDA: 'bienvenida',<br>  COTIZACION: 'cotizacion',<br>  // ... todos<br>};<br><br>const NOTIFICATION_PRIORITIES = {<br>  CRITICAL: 'critical',<br>  HIGH: 'high',<br>  MEDIUM: 'medium',<br>  LOW: 'low'<br>};<br><br>module.exports = { NOTIFICATION_TYPES, NOTIFICATION_PRIORITIES };<br>``` |
| LOW-004 | BAJO | `changanet-backend/src/tests/unit/availability/notificationService.test.js` | - | Tests unitarios insuficientes | Solo cubren casos b谩sicos | Riesgo de regresiones | ```javascript<br>// Crear suite completa de tests<br>describe('NotificationService', () => {<br>  describe('createNotification', () => {<br>    it('should create notification with valid data', async () => {<br>      // Test b谩sico<br>    });<br><br>    it('should handle rate limiting', async () => {<br>      // Test rate limiting<br>    });<br><br>    it('should validate input parameters', async () => {<br>      // Test validaci贸n<br>    });<br>  });<br><br>  // M谩s tests para todos los m茅todos<br>});<br>``` |
| LOW-005 | BAJO | `changanet-backend/README.md` | - | Documentaci贸n insuficiente del m贸dulo | Falta documentaci贸n de API y arquitectura | Dificultad para nuevos desarrolladores | ```markdown<br># Notification System Documentation<br><br>## Architecture Overview<br>- Backend services structure<br>- Database schema<br>- WebSocket implementation<br><br>## API Reference<br>### Endpoints<br>- `GET /api/notifications` - Get user notifications<br>- `PUT /api/notifications/:id/read` - Mark as read<br><br>## Configuration<br>- Environment variables<br>- Database migrations<br><br>## Development<br>- Running tests<br>- Adding new notification types<br>``` |

---

##  RESUMEN DE CORRECCIONES POR CATEGORA

### **FASE 1: CRTICA (Semana 1-2)**
- [ ] Implementar WebSocket server completo
- [ ] Crear modelos de BD faltantes
- [ ] Corregir rate limiting
- [ ] Implementar push notification service
- [ ] Arreglar autenticaci贸n WebSocket
- [ ] Optimizar consultas N+1

### **FASE 2: ALTA (Semana 3-4)**
- [ ] Corregir campos BD inconsistentes
- [ ] Arreglar API client
- [ ] Implementar endpoints faltantes
- [ ] Completar rutas API
- [ ] Mejorar reconexi贸n WebSocket
- [ ] Robustecer manejo de errores Redis
- [ ] Completar servicio de plantillas
- [ ] Implementar WebSocket broadcasting

### **FASE 3: MEDIA (Semana 5-6)**
- [ ] Agregar indicadores de prioridad
- [ ] Implementar agrupaci贸n de notificaciones
- [ ] Mejorar validaci贸n de entrada
- [ ] Agregar estados de loading/error
- [ ] Implementar m茅tricas autom谩ticas
- [ ] Agregar paginaci贸n completa
- [ ] Completar tipos TypeScript
- [ ] Implementar scheduling real
- [ ] Configurar CORS para WebSocket

### **FASE 4: BAJA (Semana 7-8)**
- [ ] Centralizar constantes y t铆tulos
- [ ] Configurar variables de entorno
- [ ] Crear archivo de constantes centralizado
- [ ] Expandir suite de tests
- [ ] Completar documentaci贸n

---

*Documento generado: 2025-11-29*
*Total de errores identificados: 28*
*Severidad: 6 Cr铆ticos, 8 Altos, 9 Medios, 5 Bajos*